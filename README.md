# hex-sort-r
## Затраченное время - 28 часов (3 календарных дня)

# HexSort – архитектура проекта


## Сцены и бутстрап
- `AppInstaller` регистрирует `SceneLoader`, `AppController` (как `IInitializable`), адаптер прогресс-бара и модель `UserDataModel`, доступную через `IUserDataGetter/IUserDataSetter`.
- `AppController.Initialize()` сразу вызывает `SceneLoader.LoadScene(EScene.CORE)` и переключает игру в CoreScene.
- `SceneLoader` загружает сцену Loading, запускает анимацию прогресс-бара, выгружает текущую сцену, загружает целевую, завершает анимацию и очищает сцену Loading.

## Внедрение зависимостей в Core-сцене
- `CoreInstaller` связывает `CoreController`, `ElementsPicker`, `FieldModel`, `FieldController`, `LevelBuilder`, `HexSlotsLoader`, `HexSlotsHandler`, `HexDeckHandler` и передаёт `CoreView`/`LevelDatabase`.
- `CoreController` при инициализации получает `CurrentLevel`, вызывает `LevelBuilder.Build(id)` и `HexSlotsHandler.SpawnStacks()`.

## Построение уровня
- `LevelBuilder` делает три шага:
  1. `HexSlotsLoader.LoadSlots()` — создаёт/позиционирует слоты.
  2. Инстанциирует префаб уровня, собирает `TileView` и строит граф `FieldModel`.
  3. Передаёт `HexDeckHandler` список `HexStackData` и доступные цвета.
- `LevelDatabase` хранит соответствия `LevelId → Prefab + Deck + AvailableColors`.

## Слоты и генерация стеков
- `HexSlotsHandler` управляет активными `HexSlotView`, слушает `SlotCleared` и при освобождении ячеек просит новые стеки у `HexDeckHandler`, регистрируя их в `FieldController`.
- `HexDeckHandler` создаёт `HexStack` из данных или генерирует случайные (по диапазонам высоты и длины серий) с помощью `PoolingSystem`.
- `HexSlotView` принимает стек, хранит ссылку и сообщает, когда слот опять свободен.

## Модель поля и автосортировка
- `FieldModel` хранит `FieldHex`: соседей, текущий стек, верхний цвет и длину серии.
- `FieldController` подписывается на `OnChunkSet`/`OnSort` у стеков, обновляет модель и ищет соседние клетки с одинаковым верхним цветом; найденные пары объединяются через `HexStack.Jump()` и цикл повторяется.

## Стек и элементы
- `HexStack` — основной игровой объект:
  - хранит `HexElement`, список серий `HexStackItemInfo`, события `OnChunkSet`/`OnSort`;
  - умеет прикрепляться к слоту (`AttachToSlot`), переезжать на тайлы (`SetChunk`), выдавать верхнюю серию (`TryGetTopRun`);
  - анимирует перенос цветовых серий (`Jump` → `SimpleArcJump`), затем физически переносит элементы, перестраивает серии, обновляет коллайдер и, опустев, освобождает тайл и возвращается в пул.
- `HexElement` содержит цвет, MeshRenderer и компонент `SimpleArcJump` для анимаций.

## Ввод и перетаскивание
- `ElementsPicker` преобразует экранные координаты в мировые, делает raycast по слою стеков и передаёт выбранный `Draggable`.
- `InputHandler` генерирует нормализованные события указателя/тача.
- `Draggable` управляет коллайдером, возвратом в слот, подсветкой `TileView` через `SphereCaster`, плавным следованием и вызывает `MoveInChunk(tile)` или `MoveBackInSlot()` в конце перетаскивания.
- `TileView` отвечает за подсветку, флаги доступности и уведомление о занятии клетки.

## Пуллинг и вспомогательные компоненты
- `PoolingSystem`, `IPoolable`, `PoolObject` реализуют ID-ориентированный пул префабов и контроль жизненного цикла объектов.
- `SphereCaster`, `RaycastHelper`, `SimpleArcJump` используются в механике перетаскивания и анимациях перелёта элементов.

## Игровой цикл
1. CoreScene устанавливается, `CoreController` строит поле и выдаёт первые стеки.
2. Игрок перетаскивает стек из слота на свободный `TileView`.
3. `FieldController` обновляет модель, ищет совпадающие вершины и инициирует перелёты.
4. Когда все слоты пусты, `HexSlotsHandler` снова заполняет их стеками, поддерживая непрерывный геймплей.


## Известные проблемы и возможные улучшения

### Баги:
Есть бага с сортировкой стаков.

### Фичекат (не сделанные механики):
- Уничтожение стаком при наборе определеного количества
- Квест/цель уровня
- Флоу победы/проигрыша и переход на следующие уровни
- 2 оригинальных бустера
- 1 уникальный бустер - шафл: при активации стаки на поле рандомна шафлятся
- USP : стик матчей. Если после установки стека на поле происходит сортировка, то накапливается стрикбонус. При накоплении до 5ти активируется бустер молнии - рандомно уничтажает один стак на поле.
- UI

### Кодовые улучшения
- Добавить FSM для экранов
- В SO LevelData вынести на уровень проекта, т.к. там могут быть значения сложности которые в мейн меню отобразить надо
- В SO LevelData заменить на гугл таблицы
- Разгрузить HexStack
- Рефакторинг и разгуз загруженых скриптов
- HexStack и HexElement - возможно объекдинить

### Улучшения другие:
- Улучить алгоритм сортировки, чтобы учитывал потанциальную возможность цепочки мержей
- Сделать, чтобы эдитор уровней, создавал json, а не префаб.
- Если игрок перетянул на гекс, который занят, но который находится по время анимации сортировки. То не отбрасывать стак назад, а подождать завершение анимации и поместить стак на этот гекс



